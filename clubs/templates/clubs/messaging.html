{% extends 'clubs/base.html' %}
{% load static %}
{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Messaging for {{ club.name }}</h2>
        <button class="btn btn-secondary" onclick="window.location.href = '/club_list/';">Exit Messaging</button>
    </div>

    <!-- Chat Notification -->
    <script>
        const roomName = "{{ room_name }}";  // Room name dynamically passed from backend
        const username = "{{ user.username }}";  // Logged-in user's username
    </script>

    <!-- Chatbox -->
    <div class="chat-box p-3 mb-4 rounded shadow"
         style="height: 500px; background-color: #f8f9fa; overflow-y: auto; border: 1px solid #dee2e6;">
        <div id="chat-area"></div> <!-- Dynamic messaging through WebSocket -->

        {% for message in messages %}
            {% if message.sender == user %}
                <!-- Message sent by logged-in user -->
                <div class="text-end mb-3">
                    <div class="d-inline-block bg-primary text-white p-3 rounded-3 shadow-sm" style="max-width: 75%;">
                        <p class="mb-2">
                            <strong>You:</strong> {{ message.content }}
                        </p>
                        <small class="text-light">{{ message.timestamp|date:"H:i" }}</small>
                    </div>
                </div>
            {% else %}
                <!-- Message sent by another user -->
                <div class="text-start mb-3">
                    <div class="d-flex align-items-start">
                        <img src="
                        {% if message.sender.profile.profile_pic and message.sender.profile.profile_pic.url %}{{ message.sender.profile.profile_pic.url }}{% else %}{% static 'clubs/images/avatar_placeholder.png' %}{% endif %}"
                             alt="{{ message.sender.username }}'s avatar"
                             class="rounded-circle me-3 shadow-sm"
                             style="width: 50px; height: 50px; object-fit: cover;">
                        <div class="d-inline-block bg-light text-dark p-3 rounded-3 shadow-sm" style="max-width: 75%;">
                            <p class="mb-2">
                                <strong>{{ message.sender.username }}:</strong> {{ message.content }}
                            </p>
                            <small class="text-muted">{{ message.timestamp|date:"H:i" }}</small>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% empty %}
            <!-- Empty State for No Messages -->
            <p class="text-muted text-center mt-5">No messages yet. Start the conversation!</p>
        {% endfor %}
    </div>

    <!-- Typing Indicator -->
    <p id="typing-indicator" class="text-muted mb-3 text-center" style="font-style: italic;"></p>

    <!-- Message Input -->
    <form method="post" class="d-flex align-items-center">
        {% csrf_token %}
        <input type="text" id="message-input" name="content" class="form-control me-3 shadow-sm"
               placeholder="Type your message..." required style="border-radius: 50px;">
        <button type="submit" class="btn btn-primary rounded-circle shadow-sm" style="width: 50px; height: 50px;">
            <i class="fas fa-paper-plane"></i>
        </button>
    </form>
</div>

<script src="{% static 'clubs/js/script.js' %}"></script>
{% endblock %}